%h1 Editing Page
= render 'form'

%p#notice= notice
%p
  %strong Book:
  = @page.book
%p
  %strong Url:
  = @page.url
%p
  %strong title:
  = @page.title
%p
  %strong thumbnail:
  %img{:src => "data:text/plain;base64, #{@page.thumbnail}", id: "thumbnail"}/

%article#main.edit
  #resize
    .items#sort
      - @orders.each_with_index do |order, index|
        .item{id: "image-#{order.image.id}"}
          %img{:src => "data:text/plain;base64, #{order.image.data}"}/
          .menubar
            .set-thumbnail
              = fa_icon "tv"
          .mask-top
            .sidemenu{ class: "number-#{index}" }
              = fa_icon "plus", text: "ここに追加"
          .mask-bottom
            .sidemenu{ class: "number-#{index + 1}" }
              = fa_icon "plus", text: "ここに追加", class: "number-1#{index + 1}"

= link_to 'Show', book_page_path(@book, @page)
|
= link_to 'Back', book_pages_path(@book)

:javascript
  $(function(){
    $('#resize').resizable({
      containment: "#main",
      minWidth: 240
    })
    $('#sort').sortable()
    $(".set-thumbnail").on("click", function(){
      var data = this.parentElement.parentElement
      var img_id = data.id.split('image-')[1]
      $.ajax({
        type: "POST",
        url: ("/books/#{@book.id}/pages/#{@page.id}/images/" + img_id + "/thumbnail"),
        success: function(data){
         $("#thumbnail")[0].src = "data:text/plain;base64, " + data.data
        }
      });
    })
    $(".sidemenu").on("click", function(){
      var order = this.className.split(" ")[0].split("number-")[1];
      $.ajax({
        type: "POST",
        url: ("/books/#{@book.id}/pages/#{@page.id}/add"),
        data: {
          order: order
        },
        success: function(data){
          console.log("success")
        }
      });
    })
    $('#sort').on('sortstop', function(){
      sorted_order = []
      $("#sort .item").each(function(index, data){
        sorted_order.push(data.id.split("image-")[1])
      })
      $.ajax({
        type: "POST",
        url: ("/books/#{@book.id}/pages/#{@page.id}/sort"),
        data: {
            "order": sorted_order
        },
        success: function(data){
        }
      });

    })
  })
